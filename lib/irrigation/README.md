# **BRISK**HOME:** ** irrigation

![Briskhome](https://img.shields.io/badge/briskhome-v0.1.4-yellow.svg) ![Версия](https://img.shields.io/badge/version-v0.1.5-brightgreen.svg)

### Описание
Модуль `briskhome-irrigation` добавляет в систему поддержку управления поливом с помощью подключенного контроллера. В качестве контроллера полива может выступать любое устройство, способное управлять электромагнитными клапанами, считывать показатели с подключенных датчиков и передавать информацию по локальной сети.

В состав модуля входят скетчи для микроконтроллера Arduino Uno.

### API
#### Controller()
Создает новый экземпляр делегата контроллера полива.

#### Controller.start(id, options)
Начинает полив указанного контура.
Метод принимает следующие параметры:
- `id` *String* - Идентификатор или название контура полива;
- `options` *Object* - Концигурационный объект:
  - `period` *Number* - Время, на которое следует открыть полив контура;
  - `moisture` *Number* - Уровень влажности почвы, по достижению которого полив следует прекратить.

#### Controller.stop(id)
Завершает полив указанного контура.
Метод принимает следующие параметры:
- `id` *String* - Идентификатор или название контура полива.

#### Controller.circuits([id, ]callback)
Возвращает список доступных контуров полива, либо возвращает подробную информацию о контуре, идентификатор или название которого было передано в качестве первого аргумента.
Метод принимает следующие параметры:
- `id` *String* - Идентификатор или название контура полива;
- `callback` *Function* - Функция обратного вызова.

### Протокол
Начиная с версии модуля 0.1.4 для взаимодействия с контроллером предусмотрена поддержка протоколов **HTTP** и **MQTT** (при помощи модулей `core.mqtt` и `core.bus`).

#### MQTT
##### Получение данных
При использовании протокола **MQTT** контроллер в автоматическом режиме осуществляет опрос подключенных датчиков и клапанов и публикует пакет данных на брокере с темой `/irrigation/circuits/:id`, где `:id` - идентификатор контура полива. Публикуемый пакет данных имеет структуру, удовлетворяющую модели данных *Circuit*, публикация пакета данных осуществляется независимо для каждого подключенного контура.

*Пример пакета данных:*
```json
{
  "name": "garden",
  "status": true,
  "sensors": {
    "moisture": 600,
    "humidity": 80,
    "temperature": 28
  }
}
```

##### Отправка данных
Управление поливом контура осуществляется путем публикации брокером или другим подключенным устройством пакета данных с темой `/irrigation/circuits/:id`, где `:id` - идентификатор контура полива. Содержимое пакета данных должно отражать желаемый статус контура полива.

*Пример пакета данных для начала полива контура:*
```json
{
  "name": "garden",
  "status": true
}
```

*Пример пакета данных для завершения полива контура:*
```json
{
  "name": "garden",
  "status": false
}
```

#### HTTP
##### Получение данных

При использовании протокола **HTTP** сервер осуществляет регулярный опрос контроллера, который, в свою очередь, собирает данные с подключенных датчиков и клапанов. Для запроса статуса контроллера полива необходимо отправить пустой GET-запрос на IP-адрес контроллера.

*Пример пакета данных:*
```
GET / HTTP/1.1
Host: 10.29.0.9
Connection: close
```

*Пример ответа контроллера:*
```json
HTTP/1.1 200 OK
Content-Type: application/json
Connection: close

[
  { "name": "garden", "status": true, "sensors": { "moisture": 200 } },
  { "..." }
]
```

##### Отправка данных
Управление поливом контура осуществляется путем отправки PUT/PATCH-запроса с информацией о названии контура и его желаемом состоянии в формате JSON. Ответом контроллера в случае успешной обработки запроса будет являться `200 OK`, а в случае, если запрос не распознан - `401 Bad Request`.

*Пример пакета данных для начала полива контура:*
```
POST / HTTP/1.1
Host: 10.29.0.9
Connection: close

{"name": "garden", "status": true}
```

*Пример пакета данных для завершения полива контура:*
```
POST / HTTP/1.1
Host: 10.29.0.9
Connection: close

{"name": "garden", "status": false}
```

### История изменений
`v0.1.4`
  - Добавлена возможность управления контроллером полива по протоколам **MQTT** и **HTTP**;
  - Добавлена возможность управления контроллером полива путем отправки сообщений по общей шине с использованием модуля `core.bus`;
  - Протокол **UDP** помечен как `устаревший` и удалён;
  - Протокол **TCP** помечен как `устаревший` и удалён;
  - Метод **Controller.status()** помечен как `устаревший` и удалён;
  - Метод **Controller.encode(message)** помечен как `устаревший` и удалён;
  - Метод **Controller.decode(message)** помечен как `устаревший` и удалён.

`v0.1.3`
  - Добавлена возможность управления контроллером полива по протоколу TCP посредством GET-запросов.

`v0.1.2`
- Добавлена возможность управления контроллером полива по протоколу UDP.
